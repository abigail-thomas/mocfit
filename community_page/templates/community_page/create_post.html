<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Create Post - MocFit+</title>

<!-- Tailwind & Material Icons -->
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" />

<!-- Bootstrap + Icons -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

{% load static %}
<link rel="stylesheet" href="{% static 'css/nav.css' %}">

<style>
  body { font-family: 'Oswald', sans-serif; }
</style>
</head>
<body class="bg-gradient-to-br from-neutral-800 to-black text-white overflow-x-hidden">

{% include 'includes/navbar.html' %}

<!-- Hero Section -->
<section class="relative text-center py-20 px-6">
  <div class="max-w-3xl mx-auto">
    <h1 class="text-5xl md:text-6xl font-extrabold uppercase mb-4">Share Your Journey</h1>
    <p class="text-gray-400 text-lg md:text-xl mb-2">
      Connect with the MocFit+ Community
    </p>
    <p class="text-gray-500 text-md">
      Post Your Progress to Becoming the Next JoelSwole
    </p>
  </div>
</section>

<!-- Create Post Form Section -->
<section class="py-8 px-4 md:px-6 flex justify-center">
  <div class="w-full max-w-2xl">
    <div class="bg-white/5 backdrop-blur-md rounded-2xl shadow-lg p-8">
      <h2 class="text-2xl font-bold text-center mb-6 uppercase">Create a New Post</h2>
      
      {% if form.errors %}
      <div class="bg-red-500/20 border border-red-500/50 rounded-xl p-4 mb-6">
        {% for field in form %}
          {% for error in field.errors %}
            <p class="flex items-center gap-2 text-red-400 text-sm mb-1">
              <i class="material-symbols-outlined text-lg">error</i> {{ error }}
            </p>
          {% endfor %}
        {% endfor %}
        {% for error in form.non_field_errors %}
          <p class="flex items-center gap-2 text-red-400 text-sm mb-1">
            <i class="material-symbols-outlined text-lg">error</i> {{ error }}
          </p>
        {% endfor %}
      </div>
      {% endif %}

      <form method="post" enctype="multipart/form-data" id="postForm">
        {% csrf_token %}
        
        <div class="mb-6">
          <label class="flex items-center gap-2 text-white font-semibold mb-3">
            <i class="material-symbols-outlined text-red-600">image</i>
            Add an Image
          </label>
          
          <div class="image-upload-area border-2 border-dashed border-white/20 rounded-xl bg-white/5 cursor-pointer transition-all hover:border-red-600 hover:bg-red-600/5" id="uploadArea">
            <div class="upload-placeholder flex flex-col items-center justify-center py-12 px-4 text-center" id="uploadPlaceholder">
              <i class="material-symbols-outlined text-6xl text-white/30 mb-4">add_photo_alternate</i>
              <p class="text-white text-lg mb-2">Click to upload or drag and drop</p>
              <span class="text-gray-500 text-sm">JPEG, PNG, or WebP • Max 5MB • Min 320x320px</span>
            </div>
            
            <div class="image-preview-container relative" id="previewContainer" style="display: none;">
              <img id="imagePreview" src="" alt="Preview" class="w-full max-h-96 object-contain rounded-xl">
              <div class="image-info flex flex-wrap gap-4 justify-center py-3 bg-black/50 text-sm" id="imageInfo"></div>
              <button type="button" class="remove-image-btn absolute top-3 right-3 w-10 h-10 rounded-full bg-black/70 text-white flex items-center justify-center hover:bg-red-600 transition-colors" id="removeImage">
                <i class="material-symbols-outlined">close</i>
              </button>
            </div>
            
            <input type="file" 
                   name="image" 
                   id="imageInput" 
                   accept="image/jpeg,image/png,image/webp"
                   class="hidden">
          </div>
          
          <div class="image-validation-message mt-3 rounded-lg" id="validationMessage"></div>
        </div>

        <div class="mb-6">
          <label class="flex items-center gap-2 text-white font-semibold mb-3">
            <i class="material-symbols-outlined text-red-600">edit_note</i>
            Add a Caption / Description
          </label>
          <textarea name="content" rows="4" 
                    class="w-full px-4 py-3 bg-white/10 text-white placeholder-gray-400 rounded-xl border border-white/10 focus:outline-none focus:ring-2 focus:ring-red-600 focus:border-transparent resize-none"
                    placeholder="Tell us about this photo or share your workout...">{{ form.content.value|default:'' }}</textarea>
        </div>

        <div class="flex flex-col md:flex-row gap-4 mt-8">
          <button type="submit" id="submitBtn"
                  class="flex-1 flex items-center justify-center gap-2 px-6 py-4 bg-gradient-to-br from-[#ba0c2f] to-[#d10e35] rounded-xl font-bold shadow-lg hover:scale-[1.02] hover:from-[#a00b2a] hover:to-[#80071c] transition-all">
            <i class="material-symbols-outlined">send</i>
            Share Post
          </button>
          <a href="{% url 'community_home' %}" 
             class="flex-1 flex items-center justify-center gap-2 px-6 py-4 bg-white/10 border border-white/20 rounded-xl font-bold hover:bg-white/20 transition-all text-center">
            <i class="material-symbols-outlined">arrow_back</i>
            Back
          </a>
        </div>
      </form>
    </div>
  </div>
</section>

<!-- Footer -->
<footer class="py-10 flex justify-center items-center border-t border-white/10">
  <p class="text-gray-400 text-sm font-semibold">MocFit+ © 2025 | Built for Students by Students</p>
</footer>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Image upload handling
    const uploadArea = document.getElementById('uploadArea');
    const uploadPlaceholder = document.getElementById('uploadPlaceholder');
    const previewContainer = document.getElementById('previewContainer');
    const imagePreview = document.getElementById('imagePreview');
    const imageInfo = document.getElementById('imageInfo');
    const imageInput = document.getElementById('imageInput');
    const removeImage = document.getElementById('removeImage');
    const validationMessage = document.getElementById('validationMessage');

    // Constants for validation
    const MAX_FILE_SIZE = 5 * 1024 * 1024; // 5MB
    const MIN_DIMENSION = 320;
    const ALLOWED_TYPES = ['image/jpeg', 'image/png', 'image/webp'];

    // Click to upload
    uploadArea.addEventListener('click', (e) => {
        if (e.target !== removeImage && !removeImage.contains(e.target)) {
            imageInput.click();
        }
    });

    // Drag and drop
    uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('border-red-600', 'bg-red-600/10');
    });

    uploadArea.addEventListener('dragleave', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('border-red-600', 'bg-red-600/10');
    });

    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('border-red-600', 'bg-red-600/10');
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            handleFile(files[0]);
        }
    });

    // File input change
    imageInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
            handleFile(e.target.files[0]);
        }
    });

    // Remove image
    removeImage.addEventListener('click', (e) => {
        e.stopPropagation();
        clearImage();
    });

    function handleFile(file) {
        // Clear previous validation messages
        validationMessage.innerHTML = '';
        validationMessage.className = 'image-validation-message mt-3 rounded-lg';

        // Check file type
        if (!ALLOWED_TYPES.includes(file.type)) {
            showError('Please upload a JPEG, PNG, or WebP image.');
            clearImage();
            return;
        }

        // Check file size
        if (file.size > MAX_FILE_SIZE) {
            const sizeMB = (file.size / (1024 * 1024)).toFixed(1);
            showError(`File too large (${sizeMB}MB). Maximum size is 5MB.`);
            clearImage();
            return;
        }

        // Create image to check dimensions
        const img = new Image();
        const objectUrl = URL.createObjectURL(file);

        img.onload = function() {
            URL.revokeObjectURL(objectUrl);

            // Check minimum dimensions
            if (img.width < MIN_DIMENSION || img.height < MIN_DIMENSION) {
                showError(`Image too small (${img.width}x${img.height}). Minimum size is ${MIN_DIMENSION}x${MIN_DIMENSION}px.`);
                clearImage();
                return;
            }

            // Valid image - show preview
            showPreview(file, img.width, img.height);
        };

        img.onerror = function() {
            URL.revokeObjectURL(objectUrl);
            showError('Could not load image. Please try another file.');
            clearImage();
        };

        img.src = objectUrl;
    }

    function showPreview(file, width, height) {
        const reader = new FileReader();
        
        reader.onload = function(e) {
            imagePreview.src = e.target.result;
            
            // Calculate aspect ratio
            const aspectRatio = (width / height).toFixed(2);
            let aspectLabel = '';
            if (Math.abs(aspectRatio - 1) < 0.1) aspectLabel = 'Square';
            else if (aspectRatio > 1) aspectLabel = 'Landscape';
            else aspectLabel = 'Portrait';
            
            const fileSizeKB = (file.size / 1024).toFixed(0);
            const fileSizeMB = (file.size / (1024 * 1024)).toFixed(1);
            const sizeDisplay = file.size > 1024 * 1024 ? `${fileSizeMB}MB` : `${fileSizeKB}KB`;
            
            imageInfo.innerHTML = `
                <span class="flex items-center gap-1 text-gray-300"><i class="material-symbols-outlined text-red-600 text-lg">straighten</i> ${width} × ${height}px</span>
                <span class="flex items-center gap-1 text-gray-300"><i class="material-symbols-outlined text-red-600 text-lg">aspect_ratio</i> ${aspectLabel}</span>
                <span class="flex items-center gap-1 text-gray-300"><i class="material-symbols-outlined text-red-600 text-lg">storage</i> ${sizeDisplay}</span>
            `;
            
            uploadPlaceholder.style.display = 'none';
            previewContainer.style.display = 'block';
            
            showSuccess('Image ready to upload!');
            
            // Set the file to the input
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(file);
            imageInput.files = dataTransfer.files;
        };
        
        reader.readAsDataURL(file);
    }

    function clearImage() {
        imageInput.value = '';
        imagePreview.src = '';
        imageInfo.innerHTML = '';
        uploadPlaceholder.style.display = 'flex';
        previewContainer.style.display = 'none';
    }

    function showError(message) {
        validationMessage.innerHTML = `<div class="flex items-center gap-2 p-3 bg-red-500/20 border border-red-500/50 rounded-lg text-red-400"><i class="material-symbols-outlined">error</i> ${message}</div>`;
    }

    function showSuccess(message) {
        validationMessage.innerHTML = `<div class="flex items-center gap-2 p-3 bg-green-500/20 border border-green-500/50 rounded-lg text-green-400"><i class="material-symbols-outlined">check_circle</i> ${message}</div>`;
    }

}); // End DOMContentLoaded
</script>
</body>
</html>
