<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Create Post - MocFit+</title>

<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" />

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

{% load static %}
<link rel="stylesheet" href="{% static 'css/nav.css' %}">

<style>
  body { font-family: 'Oswald', sans-serif; }
  /* Animation for the spinner */
  @keyframes spin { 100% { transform: rotate(360deg); } }
  .spinner {
      border: 3px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top: 3px solid white;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
      display: inline-block;
  }
</style>
</head>
<body class="bg-gradient-to-br from-neutral-800 to-black text-white overflow-x-hidden min-h-screen flex flex-col">

{% include 'includes/navbar.html' %}

<div id="mainContent" class="flex-grow">

    <section class="relative text-center pt-28 pb-10 px-6">
      <div class="max-w-3xl mx-auto">
        <h1 class="text-5xl md:text-6xl font-extrabold uppercase mb-4">Share Your Journey</h1>
        <p class="text-gray-400 text-lg md:text-xl">
          Post Your Progress to Becoming the Next JoelSwole
        </p>
      </div>
    </section>

    <section class="pb-20 px-4 md:px-6 flex justify-center">
      <div class="w-full max-w-2xl">
        <div class="bg-white/5 backdrop-blur-md rounded-2xl shadow-xl p-8 border border-white/10">
          
          <h2 class="text-2xl font-bold text-center mb-8 uppercase tracking-wide border-b border-white/10 pb-4">
            <i class="bi bi-pencil-square text-[#ba0c2f] mr-2"></i> New Post
          </h2>
          
          {% if form.errors %}
          <div id="django-errors" class="hidden">
            {% for field in form %}
              {% for error in field.errors %}{{ error }}|{% endfor %}
            {% endfor %}
            {% for error in form.non_field_errors %}{{ error }}|{% endfor %}
          </div>
          {% endif %}

          <form method="post" enctype="multipart/form-data" id="postForm">
            {% csrf_token %}
            
            <div class="mb-8">
              <label class="flex items-center gap-2 text-gray-300 font-bold uppercase text-sm tracking-wider mb-3">
                <i class="material-symbols-outlined text-[#ba0c2f]">image</i>
                Upload Photo
              </label>
              
              <div class="image-upload-area border-2 border-dashed border-white/20 rounded-xl bg-black/20 cursor-pointer transition-all hover:border-[#ba0c2f] hover:bg-[#ba0c2f]/5 group" id="uploadArea">
                
                <div class="upload-placeholder flex flex-col items-center justify-center py-12 px-4 text-center transition-opacity" id="uploadPlaceholder">
                  <div class="w-16 h-16 rounded-full bg-white/5 flex items-center justify-center mb-4 group-hover:scale-110 transition-transform duration-300">
                      <i class="material-symbols-outlined text-4xl text-gray-400 group-hover:text-white">add_photo_alternate</i>
                  </div>
                  <p class="text-white text-lg font-semibold mb-1">Click or Drop Image Here</p>
                  <span class="text-gray-500 text-sm">Max 5MB • JPEG, PNG, WebP</span>
                </div>
                
                <div class="image-preview-container relative hidden" id="previewContainer">
                  <img id="imagePreview" src="" alt="Preview" class="w-full max-h-[500px] object-contain rounded-xl bg-black/50">
                  
                  <div class="absolute bottom-0 left-0 right-0 bg-black/70 backdrop-blur-sm p-3 rounded-b-xl border-t border-white/10 flex flex-wrap gap-4 justify-center text-xs md:text-sm" id="imageInfo">
                      </div>

                  <button type="button" class="absolute top-3 right-3 w-10 h-10 rounded-full bg-black/60 text-white flex items-center justify-center hover:bg-[#ba0c2f] transition-all border border-white/10 shadow-lg hover:scale-110" id="removeImage">
                    <i class="material-symbols-outlined">close</i>
                  </button>
                </div>
                
                <input type="file" name="image" id="imageInput" accept="image/jpeg,image/png,image/webp" class="hidden">
              </div>
            </div>

            <div class="mb-8">
              <label class="flex items-center gap-2 text-gray-300 font-bold uppercase text-sm tracking-wider mb-3">
                <i class="material-symbols-outlined text-[#ba0c2f]">edit_note</i>
                Caption
              </label>
              <textarea name="content" rows="4" 
                        class="w-full px-4 py-3 bg-black/20 text-white placeholder-gray-500 rounded-xl border border-white/10 focus:outline-none focus:border-[#ba0c2f] focus:ring-1 focus:ring-[#ba0c2f] transition-all resize-none"
                        placeholder="Write a caption... (e.g., Just hit a new PR!)">{{ form.content.value|default:'' }}</textarea>
            </div>

<div class="flex flex-col md:flex-row gap-4 mt-8">
              
              <button type="submit" id="submitBtn"
                      class="flex-1 flex items-center justify-center gap-2 px-6 py-4 bg-gradient-to-br from-[#ba0c2f] to-[#d10e35] rounded-xl font-bold uppercase tracking-wider shadow-lg hover:shadow-red-900/40 hover:scale-[1.02] hover:brightness-110 transition-all duration-300 text-white group">
                <i class="material-symbols-outlined text-xl group-hover:rotate-12 transition-transform duration-300">send</i>
                <span>Share Post</span>
              </button>
              
              <a href="{% url 'community_home' %}" 
                 class="group flex-1 flex items-center justify-center gap-2 px-6 py-4 bg-black/40 hover:bg-black/60 border border-white/10 hover:border-white/30 rounded-xl font-bold uppercase tracking-wider transition-all duration-300 text-gray-300 hover:text-white no-underline shadow-md backdrop-blur-md">
                <i class="material-symbols-outlined transition-transform duration-300 group-hover:-translate-x-1 text-[#ba0c2f]">arrow_back</i>
                Back to Feed
              </a>
              
            </div>

          </form>
        </div>
      </div>
    </section>

</div>

<footer class="py-10 flex justify-center items-center border-t border-white/10 mt-auto bg-black/20">
  <p class="text-gray-400 text-sm font-semibold">MocFit+ © 2025 | Built for Students by Students</p>
</footer>

<div id="toast-container" class="fixed bottom-5 right-5 z-50 flex flex-col gap-3 pointer-events-none"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
// --- 1. TOAST FUNCTION (Identical to Feed) ---
function showToast(message, type = 'success') {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    
    const bgClass = type === 'error' ? 'bg-[#ba0c2f]' : 'bg-emerald-600'; 
    const icon = type === 'error' ? 'error' : 'check_circle';
    
    toast.className = `${bgClass} text-white px-6 py-4 rounded-xl shadow-2xl flex items-center gap-3 transform translate-y-10 opacity-0 transition-all duration-300 pointer-events-auto min-w-[300px] border border-white/10 backdrop-blur-md`;
    
    toast.innerHTML = `
        <i class="material-symbols-outlined text-2xl">${icon}</i>
        <p class="font-bold text-sm m-0 tracking-wide uppercase">${message}</p>
    `;

    container.appendChild(toast);

    requestAnimationFrame(() => {
        toast.classList.remove('translate-y-10', 'opacity-0');
    });

    setTimeout(() => {
        toast.classList.add('translate-y-10', 'opacity-0');
        setTimeout(() => toast.remove(), 300);
    }, 4000);
}

document.addEventListener('DOMContentLoaded', function() {
    
    // --- 2. HANDLE DJANGO ERRORS ---
    const errorDiv = document.getElementById('django-errors');
    if (errorDiv) {
        const errorText = errorDiv.textContent.trim();
        if (errorText) {
            const errors = errorText.split('|').filter(e => e.trim().length > 0);
            errors.forEach(err => showToast(err, 'error'));
        }
    }

    // --- 3. IMAGE UPLOAD LOGIC ---
    const form = document.getElementById('postForm');
    const submitBtn = document.getElementById('submitBtn');
    const uploadArea = document.getElementById('uploadArea');
    const previewContainer = document.getElementById('previewContainer');
    const imagePreview = document.getElementById('imagePreview');
    const imageInfo = document.getElementById('imageInfo');
    const imageInput = document.getElementById('imageInput');
    const removeImage = document.getElementById('removeImage');
    const uploadPlaceholder = document.getElementById('uploadPlaceholder');

    const MAX_FILE_SIZE = 5 * 1024 * 1024; // 5MB
    const ALLOWED_TYPES = ['image/jpeg', 'image/png', 'image/webp'];

    // Drag & Drop
    uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.classList.add('border-[#ba0c2f]', 'bg-[#ba0c2f]/10'); });
    uploadArea.addEventListener('dragleave', (e) => { e.preventDefault(); uploadArea.classList.remove('border-[#ba0c2f]', 'bg-[#ba0c2f]/10'); });
    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('border-[#ba0c2f]', 'bg-[#ba0c2f]/10');
        if (e.dataTransfer.files.length > 0) handleFile(e.dataTransfer.files[0]);
    });

    // Click to Upload
    uploadArea.addEventListener('click', (e) => {
        if (e.target !== removeImage && !removeImage.contains(e.target)) imageInput.click();
    });

    imageInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) handleFile(e.target.files[0]);
    });

    removeImage.addEventListener('click', (e) => {
        e.stopPropagation();
        clearImage();
    });

    // --- 4. FORM SUBMISSION (LOADING STATE) ---
    form.addEventListener('submit', function(e) {
        const hasImage = imageInput.files.length > 0;
        const hasContent = form.querySelector('textarea').value.trim().length > 0;

        if (!hasImage && !hasContent) {
            e.preventDefault();
            showToast('Add a photo or caption first!', 'error');
            return;
        }

        // Lock UI
        submitBtn.disabled = true;
        // Use custom CSS spinner defined in head
        submitBtn.innerHTML = `<span class="spinner mr-2"></span> Posting...`;
        submitBtn.classList.add('opacity-75', 'cursor-not-allowed');
    });

    function handleFile(file) {
        if (!ALLOWED_TYPES.includes(file.type)) {
            showToast('Only JPEG, PNG, or WebP images', 'error');
            return;
        }
        if (file.size > MAX_FILE_SIZE) {
            showToast('File too large (Max 5MB)', 'error');
            return;
        }

        const img = new Image();
        const objectUrl = URL.createObjectURL(file);

        img.onload = function() {
            URL.revokeObjectURL(objectUrl);
            
            // Aspect Ratio Warning
            const ratio = img.width / img.height;
            let warningHtml = '';
            if (ratio < 0.75) { 
                warningHtml = `<span class="text-yellow-400 flex items-center gap-1"><i class="bi bi-exclamation-triangle-fill"></i> Tall image may be cropped</span>`;
            }

            imagePreview.src = objectUrl;
            const sizeMB = (file.size / (1024 * 1024)).toFixed(1);
            
            imageInfo.innerHTML = `
                <span class="text-gray-300 flex items-center gap-1"><i class="material-symbols-outlined text-[#ba0c2f] text-sm">straighten</i> ${img.width}×${img.height}</span>
                <span class="text-gray-300 flex items-center gap-1"><i class="material-symbols-outlined text-[#ba0c2f] text-sm">storage</i> ${sizeMB}MB</span>
                ${warningHtml}
            `;
            
            uploadPlaceholder.classList.add('hidden');
            previewContainer.classList.remove('hidden');
            
            // Sync file input
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(file);
            imageInput.files = dataTransfer.files;
            
            // Fallback render
            const reader = new FileReader();
            reader.onload = (e) => imagePreview.src = e.target.result;
            reader.readAsDataURL(file);
        };
        img.src = objectUrl;
    }

    function clearImage() {
        imageInput.value = '';
        imagePreview.src = '';
        imageInfo.innerHTML = '';
        uploadPlaceholder.classList.remove('hidden');
        previewContainer.classList.add('hidden');
    }
});
</script>
</body>
</html>