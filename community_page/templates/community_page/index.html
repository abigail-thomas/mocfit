<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Community - MocFit+</title>

<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" />

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

{% load static %}
<link rel="stylesheet" href="{% static 'css/nav.css' %}">

<style>
  body { font-family: 'Oswald', sans-serif; }
  .like-btn.liked i { color: #dc2626; }
  .like-btn.liked .bi-heart::before { content: "\f415"; }
</style>
</head>
<body class="bg-gradient-to-br from-neutral-800 to-black text-white overflow-x-hidden">

{% include 'includes/navbar.html' %}

<div id="mainContent">

<section class="relative text-center pt-28 pb-10 px-6">
  <div class="max-w-3xl mx-auto">
    <h1 class="text-5xl md:text-6xl font-extrabold uppercase mb-4">Community Feed</h1>
    <p class="text-gray-400 text-lg md:text-xl mb-8">
      Connect with Fellow FSC Fitness Enthusiasts
    </p>
    
    {% if user.is_authenticated %}
      <a href="{% url 'create_post' %}" 
         class="inline-block px-8 py-4 bg-gradient-to-br from-[#ba0c2f] to-[#d10e35] rounded-lg font-bold shadow-lg hover:scale-105 hover:from-[#a00b2a] hover:to-[#80071c] transition-transform duration-300">
         + Create Post
      </a>
    {% endif %}
  </div>
</section>

<section class="pb-16 px-4 md:px-6 flex justify-center">
  <div class="w-full max-w-xl space-y-6">

    {% if user.is_authenticated %}
    <!-- Sort Dropdown -->
    <div class="flex justify-end items-center gap-3">
      <label for="sortSelect" class="text-gray-400 text-sm font-bold uppercase tracking-wider">Sort by:</label>
      <div class="relative group">
        <select id="sortSelect" 
                onchange="window.location.href='?sort=' + this.value"
                class="appearance-none bg-black/20 backdrop-blur-sm border border-white/20 text-white text-sm font-bold uppercase tracking-wider rounded-lg pl-5 pr-12 py-2.5 cursor-pointer hover:bg-white/10 hover:border-white/40 focus:outline-none focus:border-[#ba0c2f] focus:ring-1 focus:ring-[#ba0c2f] transition-all duration-300 font-['Oswald']">
          <option value="recent" {% if current_sort == 'recent' %}selected{% endif %} class="bg-neutral-900 text-gray-200">Most Recent</option>
          <option value="oldest" {% if current_sort == 'oldest' %}selected{% endif %} class="bg-neutral-900 text-gray-200">Oldest Posts</option>
          <option value="likes" {% if current_sort == 'likes' %}selected{% endif %} class="bg-neutral-900 text-gray-200">Most Liked</option>
        </select>
        <i class="material-symbols-outlined absolute right-3 top-1/2 -translate-y-1/2 text-[#ba0c2f] pointer-events-none text-xl group-hover:text-white transition-colors duration-300">
            keyboard_arrow_down
        </i>
      </div>
    </div>
    {% endif %}

    {% if not user.is_authenticated %}
    <div class="bg-white/5 backdrop-blur-sm border border-white/10 rounded-2xl p-8 text-center shadow-xl">
        <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-white/10 mb-6">
            <i class="material-symbols-outlined text-4xl text-[#ba0c2f]">lock</i>
        </div>
        
        <h2 class="text-2xl font-bold uppercase mb-3">Members Only Content</h2>
        <p class="text-gray-300 mb-8 max-w-md mx-auto">
            Join the MocFit+ community to view posts, like, comment, and share your fitness journey with other students!
        </p>

        <div class="flex flex-col sm:flex-row gap-4 justify-center">
            <a href="/accounts/" 
               class="px-8 py-3 bg-[#ba0c2f] hover:bg-[#d10e35] rounded-lg font-bold transition-colors shadow-lg text-white no-underline">
               Log In
            </a>
            <a href="/accounts/register/" 
               class="px-8 py-3 bg-transparent border border-white/30 hover:bg-white/10 rounded-lg font-bold transition-colors text-white no-underline">
               Sign Up
            </a>
        </div>
    </div>

    {% else %}
    {% for post in posts %}
      <div class="post-card bg-white/5 backdrop-blur-md rounded-2xl shadow-md overflow-hidden hover:scale-[1.01] transition-transform duration-200">
        
        <div class="flex justify-between items-center px-4 py-3 border-b border-white/10">
          <div class="flex items-center gap-3">
            <i class="material-symbols-outlined text-red-600 text-3xl">account_circle</i>
            <h3 class="font-semibold text-lg">{{ post.author.username }}</h3>
          </div>
          <p class="text-gray-400 text-sm">{{ post.created_at|date:"M j, Y" }}</p>
        </div>

        <div class="px-4 py-3 text-gray-300">
          
          {% if post.image %}
          <div class="flex justify-center items-center mb-3">
            <img src="{{ post.image.url }}" alt="Post image"
                 class="w-full h-96 object-cover rounded-xl shadow-sm" loading="lazy">
          </div>
          {% endif %}

          {% if post.content %}
            <p class="break-words text-sm md:text-base">
              <span class="font-bold text-white mr-2">{{ post.author.username }}</span>
              {{ post.content }}
            </p>
          {% endif %}
          
        </div>

        <div class="flex items-center gap-4 px-4 py-2 border-t border-white/10">
          <form action="{% url 'like_post' post.id %}" method="post" class="flex items-center gap-2 like-form" data-post-id="{{ post.id }}">
            {% csrf_token %}
            <button type="button" class="flex items-center gap-1 like-btn {% if user in post.likes.all %}liked{% endif %}">
              <i class="bi bi-heart text-red-600 text-xl"></i>
              <span class="like-count">{{ post.total_likes }}</span>
            </button>
          </form>

          {% if user == post.author %}
          <form action="{% url 'delete_post' post.id %}" method="post" class="delete-form ml-auto" data-post-id="{{ post.id }}">
            {% csrf_token %}
            <button type="button" class="flex items-center gap-1 delete-btn text-gray-400 hover:text-red-600 transition-colors">
              <i class="material-symbols-outlined">delete</i> Delete
            </button>
          </form>
          {% endif %}
        </div>

        <div class="comments-section px-4 py-2 border-t border-white/10">
          <h4 class="text-gray-200 font-semibold mb-2">Comments</h4>
          <div class="comments-list space-y-2">
            {% for comment in post.comments.all %}
            <div class="comment flex justify-between items-start bg-white/10 rounded-xl p-2">
              <div>
                <strong class="text-red-500">{{ comment.author.username }}</strong>
                <span class="text-gray-500 text-xs ml-2">{{ comment.created_at|date:"m/d/Y" }}</span>
                <p class="text-gray-300 text-sm">{{ comment.content }}</p>
              </div>
              {% if user == comment.author %}
              <form action="{% url 'delete_comment' comment.id %}" method="post" class="delete-comment-form" data-comment-id="{{ comment.id }}">
                {% csrf_token %}
                <button type="button" class="delete-comment-btn text-gray-400 hover:text-red-600 transition-colors">
                  <i class="material-symbols-outlined text-lg">delete</i>
                </button>
              </form>
              {% endif %}
            </div>
            {% empty %}
            <p class="no-comments text-gray-500 italic text-sm">No comments yet. Be the first to comment!</p>
            {% endfor %}
          </div>

          <form action="{% url 'add_comment' post.id %}" method="post" class="comment-form mt-3 flex flex-col md:flex-row gap-2" data-post-id="{{ post.id }}">
            {% csrf_token %}
            {{ comment_form.content }}
            <button type="button" class="comment-submit-btn px-4 py-2 bg-[#d10e35] rounded-lg font-semibold hover:bg-[#ba0c2f] transition-colors w-full md:w-auto">
              Comment
            </button>
          </form>
        </div>

      </div>
      {% empty %}
      <div class="text-center text-gray-400 py-16">
        <i class="material-symbols-outlined text-5xl mb-4">forum</i>
        <h2 class="text-2xl font-bold mb-2">No posts yet</h2>
        <p>Be the first to share something with the community!</p>
      </div>
      {% endfor %}
    
    {% endif %} </div>
</section>

</div>

<footer class="py-10 flex justify-center items-center border-t border-white/10">
  <p class="text-gray-400 text-sm font-semibold">MocFit+ Â© 2025 | Built for Students by Students</p>
</footer>

<div id="toast-container" class="fixed bottom-5 right-5 z-50 flex flex-col gap-3 pointer-events-none"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

<script>
  // 1. TOAST NOTIFICATION FUNCTION
  function showToast(message, type = 'success') {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      
      // Choose colors: Brand Red for error, Green for success
      // You can change 'bg-green-600' to your brand color if you prefer
      const bgClass = type === 'error' ? 'bg-[#ba0c2f]' : 'bg-emerald-600'; 
      const icon = type === 'error' ? 'error' : 'check_circle';
      
      // Toast Styling
      toast.className = `${bgClass} text-white px-6 py-4 rounded-xl shadow-2xl flex items-center gap-3 transform translate-y-10 opacity-0 transition-all duration-300 pointer-events-auto min-w-[300px] border border-white/10 backdrop-blur-md`;
      
      toast.innerHTML = `
          <i class="material-symbols-outlined text-2xl">${icon}</i>
          <p class="font-bold text-sm m-0 tracking-wide uppercase">${message}</p>
      `;
  
      container.appendChild(toast);
  
      // Animate In
      requestAnimationFrame(() => {
          toast.classList.remove('translate-y-10', 'opacity-0');
      });
  
      // Remove after 3 seconds
      setTimeout(() => {
          toast.classList.add('translate-y-10', 'opacity-0');
          setTimeout(() => toast.remove(), 300);
      }, 3000);
  }
  
  document.addEventListener('DOMContentLoaded', function() {
      
      // 2. LIKE BUTTON
      document.querySelectorAll('.like-btn').forEach(button => {
          button.addEventListener('click', async () => {
              const form = button.closest('.like-form');
              if (!form) return;
              
              const countSpan = button.querySelector('.like-count');
              const csrftoken = form.querySelector('[name=csrfmiddlewaretoken]').value;
  
              // Toggle the like visually right away (Optimistic UI)
              const liked = button.classList.toggle('liked');
              let count = parseInt(countSpan.textContent);
              countSpan.textContent = liked ? count + 1 : count - 1;
  
              try {
                  await fetch(form.action, {
                      method: 'POST',
                      headers: { 'X-CSRFToken': csrftoken },
                  });
              } catch (error) {
                  console.error('Like request failed:', error);
                  // Revert if it fails
                  button.classList.toggle('liked');
                  countSpan.textContent = liked ? count - 1 : count + 1;
                  showToast('Connection error', 'error');
              }
          });
      });
  
      // 3. DELETE POST BUTTON
      document.querySelectorAll('.delete-btn').forEach(button => {
          button.addEventListener('click', async () => {
              const form = button.closest('.delete-form');
              if (!form) return;
              const csrftoken = form.querySelector('[name=csrfmiddlewaretoken]').value;
  
              if (!confirm('Are you sure you want to delete this post?')) return;
  
              try {
                  const response = await fetch(form.action, {
                      method: 'POST',
                      headers: { 'X-CSRFToken': csrftoken },
                  });
  
                  const data = await response.json();
                  if (data.deleted) {
                      showToast('Post deleted successfully', 'success'); // Toast Success
                      const postCard = form.closest('.post-card');
                      postCard.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
                      postCard.style.opacity = '0';
                      postCard.style.transform = 'scale(0.95)';
                      setTimeout(() => postCard.remove(), 300);
                  }
              } catch (error) {
                  console.error('Error deleting post:', error);
                  showToast('Could not delete post', 'error'); // Toast Error
              }
          });
      });
  
      // 4. DELETE COMMENT BUTTON
      document.body.addEventListener('click', async function(e) {
          // We use event delegation here so it works on NEW comments too
          const button = e.target.closest('.delete-comment-btn');
          if (!button) return;
  
          const form = button.closest('.delete-comment-form');
          if (!form) return;
          const csrftoken = form.querySelector('[name=csrfmiddlewaretoken]').value;
  
          if (!confirm('Are you sure you want to delete this comment?')) return;
  
          try {
              const response = await fetch(form.action, {
                  method: 'POST',
                  headers: { 'X-CSRFToken': csrftoken },
              });
  
              const data = await response.json();
              if (data.deleted) {
                  showToast('Comment deleted', 'success'); // Toast Success
                  const comment = form.closest('.comment');
                  comment.style.transition = 'opacity 0.3s ease';
                  comment.style.opacity = '0';
                  setTimeout(() => comment.remove(), 300);
              } else {
                  showToast('Failed to delete comment', 'error'); // Toast Error
              }
          } catch (error) {
              console.error('Error deleting comment:', error);
              showToast('Error deleting comment', 'error');
          }
      });
  
      // 5. ADD COMMENT BUTTON
      document.querySelectorAll('.comment-submit-btn').forEach(button => {
          button.addEventListener('click', async () => {
              const form = button.closest('.comment-form');
              if (!form) return;
              
              const textarea = form.querySelector('textarea');
              const content = textarea.value.trim();
              const csrftoken = form.querySelector('[name=csrfmiddlewaretoken]').value;
              
              if (!content) {
                  showToast('Please enter a comment', 'error'); // Toast Error
                  return;
              }
  
              // Disable button to prevent double clicks
              const originalText = button.innerHTML;
              button.disabled = true;
              button.innerHTML = 'Posting...';
              button.classList.add('opacity-50', 'cursor-not-allowed');
              
              try {
                  const response = await fetch(form.action, {
                      method: 'POST',
                      headers: {
                          'X-CSRFToken': csrftoken,
                          'Content-Type': 'application/x-www-form-urlencoded',
                      },
                      body: `content=${encodeURIComponent(content)}`
                  });
                  
                  const data = await response.json();
                  
                  if (data.success) {
                      showToast('Comment added!', 'success'); // Toast Success
                      
                      textarea.value = '';
                      const commentsList = form.closest('.comments-section').querySelector('.comments-list');
                      const noComments = commentsList.querySelector('.no-comments');
                      if (noComments) noComments.remove();
                      
                      const newComment = document.createElement('div');
                      newComment.className = 'comment flex justify-between items-start bg-white/10 rounded-xl p-2';
                      newComment.style.opacity = '0';
                      newComment.style.transition = 'opacity 0.3s ease';
                      
                      // We need the ID for the delete URL
                      const deleteUrl = "{% url 'delete_comment' 99999 %}".replace('99999', data.comment.id);
                      
                      newComment.innerHTML = `
                          <div>
                              <strong class="text-red-500">${data.comment.author}</strong>
                              <span class="text-gray-500 text-xs ml-2">${data.comment.created_at}</span>
                              <p class="text-gray-300 text-sm">${data.comment.content}</p>
                          </div>
                          <form action="${deleteUrl}" method="post" class="delete-comment-form" data-comment-id="${data.comment.id}">
                              <input type="hidden" name="csrfmiddlewaretoken" value="${csrftoken}">
                              <button type="button" class="delete-comment-btn text-gray-400 hover:text-red-600 transition-colors">
                                  <i class="material-symbols-outlined text-lg">delete</i>
                              </button>
                          </form>
                      `;
                      
                      commentsList.appendChild(newComment);
                      setTimeout(() => newComment.style.opacity = '1', 10);
                      
                  } else {
                      showToast(data.error || 'Failed to add comment', 'error');
                  }
              } catch (error) {
                  console.error('Error adding comment:', error);
                  showToast('Connection error', 'error');
              } finally {
                  // Re-enable button
                  button.disabled = false;
                  button.innerHTML = originalText;
                  button.classList.remove('opacity-50', 'cursor-not-allowed');
              }
          });
      });
  
  }); // End DOMContentLoaded
  </script>
</script>
</body>
</html>