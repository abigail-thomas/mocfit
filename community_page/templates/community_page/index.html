<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Community - MocFit+</title>

<!-- Tailwind & Material Icons -->
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" />


<!-- Bootstrap + Icons -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

{% load static %}
<link rel="stylesheet" href="{% static 'css/nav.css' %}">

<style>
  body { font-family: 'Oswald', sans-serif; }
</style>
</head>
<body class="bg-gradient-to-br from-neutral-900 to-black text-white min-h-screen">

{% include 'includes/navbar.html' %}

<!-- Hero Section -->
<section class="relative text-center py-28 px-6">
  <div class="max-w-3xl mx-auto">
    <h1 class="text-5xl md:text-6xl font-extrabold uppercase mb-4">Community Feed</h1>
    <p class="text-gray-400 text-lg md:text-xl mb-8">
      Connect with Fellow FSC Fitness Enthusiasts
    </p>
    {% if user.is_authenticated %}
      <a href="{% url 'create_post' %}" 
         class="inline-block px-8 py-4 bg-gradient-to-br from-[#ba0c2f] to-[#d10e35] rounded-lg font-bold shadow-lg hover:scale-105 hover:from-[#a00b2a] hover:to-[#80071c] transition-transform duration-300">
         + Create Post
      </a>
    {% else %}
      <p class="text-gray-400">
        Please <a href="/accounts/" class="text-[#d10e35] underline">login</a> to create posts and join the conversation
      </p>
    {% endif %}
  </div>
</section>
<!-- Posts Section -->
<section class="py-16 px-4 md:px-6 flex justify-center">
  <div class="w-full max-w-xl space-y-6">
    {% for post in posts %}
    <div class="bg-white/5 backdrop-blur-md rounded-2xl shadow-md overflow-hidden hover:scale-[1.01] transition-transform duration-200">
      
      <!-- Post Header -->
      <div class="flex justify-between items-center px-4 py-3 border-b border-white/10">
        <div class="flex items-center gap-3">
          <i class="material-symbols-outlined text-red-600 text-3xl">account_circle</i>
          <h3 class="font-semibold text-lg">{{ post.author.username }}</h3>
        </div>
        <p class="text-gray-400 text-sm">{{ post.created_at|date:"M j, Y" }}</p>
      </div>

      <!-- Post Content -->
      <div class="px-4 py-3 text-gray-300">
        <p class="mb-3 ml-5 break-words">{{ post.content }}</p>
        {% if post.image %}
        <div class="flex justify-center items-center">
          <img src="{{ post.image.url }}" alt="Post image"
               class="w-96 h-96 object-cover rounded-xl shadow-sm mb-2 ">
        </div>
        {% endif %}

      </div>

      <!-- Post Actions -->
      <div class="flex items-center gap-4 px-4 py-2 border-t border-white/10">
        {% if user.is_authenticated %}
        <form action="{% url 'like_post' post.id %}" method="post" class="flex items-center gap-2 like-form" data-post-id="{{ post.id }}">
          {% csrf_token %}
          <button type="button" class="flex items-center gap-1 action-btn like-btn {% if user in post.likes.all %}liked{% endif %}">
            <i class="bi bi-heart text-red-600"></i>
            <span class="like-count">{{ post.total_likes }}</span>
          </button>
        </form>
        {% else %}
        <div class="flex items-center gap-1">
            <i class="bi bi-heart text-red-600"></i>
          <span>{{ post.total_likes }}</span>
        </div>
        {% endif %}

        {% if user == post.author %}
        <form action="{% url 'delete_post' post.id %}" method="post" class="ml-auto">
          {% csrf_token %}
          <button type="button" class="flex items-center gap-1 action-btn delete-btn text-gray-400 hover:text-red-600">
            <i class="material-symbols-outlined">delete</i> Delete
          </button>
        </form>
        {% endif %}
      </div>

      <!-- Comments Section -->
      <div class="px-4 py-2">
        <h4 class="text-gray-200 font-semibold mb-2">Comments</h4>
        <div class="space-y-2">
          {% for comment in post.comments.all %}
          <div class="flex justify-between items-start bg-white/10 rounded-xl p-2">
            <div>
              <strong class="text-red-500">{{ comment.author.username }}</strong>
              <p class="text-gray-300 text-sm">{{ comment.content }}</p>
            </div>
            {% if user == comment.author %}
            <form action="{% url 'delete_comment' comment.id %}" method="post" class="delete-comment-form">
              {% csrf_token %}
              <button type="button" class="text-gray-400 hover:text-red-600">
                <i class="material-symbols-outlined">delete</i>
              </button>
            </form>
            {% endif %}
          </div>
          {% empty %}
          <p class="text-gray-500 italic text-sm">No comments yet. Be the first to comment!</p>
          {% endfor %}
        </div>

        {% if user.is_authenticated %}
        <form action="{% url 'add_comment' post.id %}" method="post" class="mt-2 flex flex-col md:flex-row gap-2">
          {% csrf_token %}
          {{ comment_form.content }}
          
          <button type="submit" class="px-4 py-2 bg-[#d10e35] rounded-lg font-semibold hover:bg-[#ba0c2f] transition-colors w-full md:w-auto">Comment</button>
        </form>
        {% endif %}
      </div>

    </div>
    {% empty %}
    <div class="text-center text-gray-400 py-16">
      <i class="material-symbols-outlined text-5xl mb-4">forum</i>
      <h2 class="text-2xl font-bold mb-2">No posts yet</h2>
      <p>Be the first to share something with the community!</p>
    </div>
    {% endfor %}
  </div>
</section>



<!-- Footer -->
<footer class="py-10 flex justify-center items-center border-t border-white/10">
  <p class="text-gray-400 text-sm font-semibold">MocFit+ Â© 2025 | Built for Students by Students</p>
</footer>


<!-- bootstrap -->
 <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>


    <script>
       

        
        // this adds the abilty to like without reloading page
        // making it more responsive
        document.querySelectorAll('.like-btn').forEach(button => {
            button.addEventListener('click', async () => {
                const form = button.closest('.like-form');
                const postId = form.dataset.postId;
                const countSpan = button.querySelector('.like-count');
                const csrftoken = form.querySelector('[name=csrfmiddlewaretoken]').value;

                // Toggle the like visually right away
                const liked = button.classList.toggle('liked');
                let count = parseInt(countSpan.textContent);
                countSpan.textContent = liked ? count + 1 : count - 1;

                // Send AJAX POST to Django backend
                try {
                    await fetch(form.action, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': csrftoken,
                        },
                    });
                } catch (error) {
                    console.error('Like request failed:', error);
                    // Revert the count if request fails
                    button.classList.toggle('liked');
                    countSpan.textContent = liked ? count - 1 : count + 1;
                }
    });
});
        // for delete button
        document.querySelectorAll('.delete-btn').forEach(button => {
            button.addEventListener('click', async () => {
                const form = button.closest('.delete-form');
                const postId = form.dataset.postId;
                const csrftoken = form.querySelector('[name=csrfmiddlewaretoken]').value;

                if (!confirm('Are you sure you want to delete this post?')) return;

                try {
                    const response = await fetch(form.action, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': csrftoken,
                        },
                    });

                    const data = await response.json();
                    if (data.deleted) {
                        // Smoothly remove the post card from the page
                        const postCard = form.closest('.post-card');
                        postCard.style.transition = 'opacity 0.3s ease';
                        postCard.style.opacity = '0';
                        setTimeout(() => postCard.remove(), 300);
                    }
                } catch (error) {
                    console.error('Error deleting post:', error);
                }
            });
        });
// For delete comment button
document.querySelectorAll('.delete-comment-btn').forEach(button => {
    button.addEventListener('click', async () => {
        const form = button.closest('.delete-comment-form');
        const commentId = form.dataset.commentId;
        const csrftoken = form.querySelector('[name=csrfmiddlewaretoken]').value;

        if (!confirm('Are you sure you want to delete this comment?')) return;

        try {
            const response = await fetch(form.action, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken,
                },
            });

            const data = await response.json();
            if (data.deleted) {
                // Smoothly remove the comment from the page
                const comment = form.closest('.comment');
                comment.style.transition = 'opacity 0.3s ease';
                comment.style.opacity = '0';
                setTimeout(() => comment.remove(), 300);
            } else {
                alert('Failed to delete comment: ' + (data.error || 'Unknown error'));
            }
        } catch (error) {
            console.error('Error deleting comment:', error);
            alert('Failed to delete comment');
        }
    });
});
    </script>
</body>
</html>