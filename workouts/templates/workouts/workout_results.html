<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MocFit+</title>
  {% load static %}
  <link rel="stylesheet" href="{% static 'css/nav.css' %}">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
  <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@200..700&family=Michroma&display=swap" rel="stylesheet">
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Flowbite -->
  <link href="https://cdn.jsdelivr.net/npm/flowbite@2.5.1/dist/flowbite.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/flowbite@2.5.1/dist/flowbite.min.js"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            'oswald': ['Oswald', 'sans-serif'],
            'michroma': ['Michroma', 'sans-serif'],
          }
        }
      }
    }
  </script>
  
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Oswald:wght@200..700&display=swap');
    
    body {
      font-family: 'Oswald', sans-serif;
    }

    .bg-gradient-dark {
      background: linear-gradient(135deg, #292727 0%, #101111 100%);
    }
    
    .bg-gradient-red {
      background: linear-gradient(135deg, #ba0c2f, #d10e35);
    }
    
    .bg-gradient-blue {
      background: linear-gradient(135deg, #0032a0, #0055cc);
    }

    .shadow-red {
      box-shadow: 0 8px 25px rgba(186, 12, 47, 0.3);
    }
    
    .shadow-blue {
      box-shadow: 0 8px 25px rgba(0, 50, 160, 0.4);
    }
  </style>
</head>
<body class="bg-gradient-dark text-white min-h-screen">
  {% include 'includes/navbar.html' %}

  <div class="max-w-6xl mx-auto px-6 md:px-10 pt-32 md:pt-36 pb-20">


    <!-- Error message -->
    {% if error_message %}
      <div class="bg-red-900/10 border-2 border-red-600 rounded-xl p-10 my-10 text-center">
        <h3 class="text-red-500 text-2xl font-semibold mb-5">Error</h3>
        <p class="text-gray-300 text-lg mb-8">{{ error_message }}</p>
        <a href="{% url 'workout_generator_page' %}" class="inline-block py-4 px-8 text-base font-bold bg-gradient-red text-white rounded-lg cursor-pointer transition-all duration-400 uppercase shadow-red hover:scale-105 hover:bg-gradient-blue hover:shadow-blue">
          Back to Generator
        </a>
      </div>

    {% elif category and exercises %}
      <!-- Random preset workout -->
      <div class="bg-white/5 rounded-xl p-6 md:p-10 mb-10 text-center transition-all duration-400 hover:bg-white/10 hover:-translate-y-0.5">
        <h1 class="text-3xl md:text-5xl font-bold mb-8 uppercase">{{ category|title }} Workout</h1>
        <div class="flex justify-center gap-6 md:gap-10 flex-wrap">
          <p class="bg-red-900/20 border border-red-600/40 rounded-lg py-4 px-6 md:px-8 text-base md:text-lg font-bold">
            Exercises: {{ total_exercises|default:"0" }}
          </p>
          <p class="bg-red-900/20 border border-red-600/40 rounded-lg py-4 px-6 md:px-8 text-base md:text-lg font-bold">
            Goal: {{ goal|title|default:"Hypertrophy" }}
          </p>
          <p class="bg-red-900/20 border border-red-600/40 rounded-lg py-4 px-6 md:px-8 text-base md:text-lg font-bold">
            Duration: {{ estimated_duration|default:"45 min" }}
          </p>
        </div>
      </div>

      {% for exercise in exercises %}
        <div class="bg-white/5 rounded-xl p-6 md:p-8 mb-6 transition-all duration-400 hover:bg-white/10 hover:-translate-y-0.5">
          <div class="flex justify-between items-center flex-wrap gap-4 mb-5">
            <h3 class="text-xl md:text-2xl font-semibold">{{ exercise.name }}</h3>
            <span class="bg-gradient-red py-2 px-5 rounded-lg text-sm font-bold">
              Exercise #{{ forloop.counter }}
            </span>
          </div>

          <div class="flex gap-3 flex-wrap my-4">
            <span class="bg-white/10 border border-white/20 py-2 px-4 rounded-lg text-sm text-gray-300 font-semibold">
              {{ exercise.get_mechanics_display|default:"Exercise" }}
            </span>
            <span class="bg-white/10 border border-white/20 py-2 px-4 rounded-lg text-sm text-gray-300 font-semibold">
              {{ exercise.get_difficulty_display }}
            </span>
            <span class="bg-white/10 border border-white/20 py-2 px-4 rounded-lg text-sm text-gray-300 font-semibold">
              {% if exercise.equipment.all %}
                {% for eq in exercise.equipment.all %}
                  {{ eq.name }}{% if not forloop.last %}, {% endif %}
                {% endfor %}
              {% else %}
                Bodyweight
              {% endif %}
            </span>
          </div>

          <div class="flex gap-3 flex-wrap my-4">
            {% for pm in exercise.primary_muscle.all %}
              <span class="bg-red-900/30 border border-red-600/50 py-1.5 px-3 rounded-md text-xs font-semibold">
                Primary: {{ pm.name }}
              </span>
            {% endfor %}
            {% for sm in exercise.secondary_muscles.all %}
              <span class="bg-red-900/30 border border-red-600/50 py-1.5 px-3 rounded-md text-xs font-semibold">
                Secondary: {{ sm.name }}
              </span>
            {% endfor %}
          </div>

          {% if exercise.description %}
            <div class="bg-white/5 border-l-4 border-red-600 rounded p-4 my-4 text-gray-300 leading-relaxed">
              {{ exercise.description }}
            </div>
          {% endif %}

          {% if exercise.image_url %}
            <img src="{{ exercise.image_url }}" alt="{{ exercise.name }}" class="w-full max-w-2xl h-auto rounded-lg mt-4 shadow-xl mx-auto">
          {% endif %}
        </div>
      {% endfor %}

    {% elif workout %}
      <!-- Generated advanced workout -->
      <div class="bg-white/5 rounded-xl p-6 md:p-10 mb-10 text-center transition-all duration-400 hover:bg-white/10 hover:-translate-y-0.5">
        <h1 class="text-3xl md:text-5xl font-bold mb-8 uppercase">Your Workout Plan</h1>
        <div class="flex justify-center gap-6 md:gap-10 flex-wrap">
          <p class="bg-red-900/20 border border-red-600/40 rounded-lg py-4 px-6 md:px-8 text-base md:text-lg font-bold">
            Exercises: {{ total_exercises|default:"0" }}
          </p>
          <p class="bg-red-900/20 border border-red-600/40 rounded-lg py-4 px-6 md:px-8 text-base md:text-lg font-bold">
            Goal: {{ goal|title|default:"Hypertrophy" }}
          </p>
          <p class="bg-red-900/20 border border-red-600/40 rounded-lg py-4 px-6 md:px-8 text-base md:text-lg font-bold">
            Duration: {{ estimated_duration|default:"45 min" }}
          </p>
        </div>
      </div>

      {% for muscle, exercises in workout.items %}
        <h2 class="text-2xl md:text-3xl font-semibold mt-12 mb-6 uppercase">{{ muscle }}</h2>
        {% for entry in exercises %}
          {% with exercise=entry.exercise %}
          <div class="bg-white/5 rounded-xl p-6 md:p-8 mb-6 transition-all duration-400 hover:bg-white/10 hover:-translate-y-0.5">
            <div class="flex justify-between items-center flex-wrap gap-4 mb-5">
              <h3 class="text-xl md:text-2xl font-semibold">{{ exercise.name }}</h3>
              {% if entry.order %}
                <span class="bg-gradient-red py-2 px-5 rounded-lg text-sm font-bold">
                  Exercise #{{ entry.order }}
                </span>
              {% endif %}
            </div>

            <div class="flex gap-3 flex-wrap my-4">
              <span class="bg-white/10 border border-white/20 py-2 px-4 rounded-lg text-sm text-gray-300 font-semibold">
                {{ exercise.get_mechanics_display|default:"Exercise" }}
              </span>
              <span class="bg-white/10 border border-white/20 py-2 px-4 rounded-lg text-sm text-gray-300 font-semibold">
                {{ exercise.get_difficulty_display }}
              </span>
              <span class="bg-white/10 border border-white/20 py-2 px-4 rounded-lg text-sm text-gray-300 font-semibold">
                {% if exercise.equipment.all %}
                  {% for eq in exercise.equipment.all %}
                    {{ eq.name }}{% if not forloop.last %}, {% endif %}
                  {% endfor %}
                {% else %}
                  Bodyweight
                {% endif %}
              </span>
            </div>

            <div class="flex gap-3 flex-wrap my-4">
              {% for pm in exercise.primary_muscle.all %}
                <span class="bg-red-900/30 border border-red-600/50 py-1.5 px-3 rounded-md text-xs font-semibold">
                  Primary: {{ pm.name }}
                </span>
              {% endfor %}
              {% for sm in exercise.secondary_muscles.all %}
                <span class="bg-red-900/30 border border-red-600/50 py-1.5 px-3 rounded-md text-xs font-semibold">
                  Secondary: {{ sm.name }}
                </span>
              {% endfor %}
            </div>

            <div class="bg-blue-900/20 border border-blue-600/40 rounded-lg p-4 my-4">
              <strong class="text-lg block mb-2">{{ entry.sets }} sets × {{ entry.reps }} reps</strong>
              {% if entry.rest %}
                <div class="text-gray-300 text-sm">Rest: {{ entry.rest }}</div>
              {% endif %}
            </div>

            {% if entry.notes %}
              <div class="bg-white/5 border-l-4 border-red-600 rounded p-4 my-4 text-gray-300 leading-relaxed">
                {{ entry.notes }}
              </div>
            {% endif %}

            {% if exercise.description %}
              <div class="bg-white/5 border-l-4 border-red-600 rounded p-4 my-4 text-gray-300 leading-relaxed">
                {{ exercise.description }}
              </div>
            {% endif %}

            {% if exercise.image_url %}
              <img src="{{ exercise.image_url }}" alt="{{ exercise.name }}" class="w-full max-w-2xl h-auto rounded-lg mt-4 shadow-xl mx-auto">
            {% endif %}
          </div>
          {% endwith %}
        {% empty %}
          <p class="text-gray-300 text-center">No exercises found for this muscle group.</p>
        {% endfor %}
      {% endfor %}

    {% else %}
      <div class="bg-red-900/10 border-2 border-red-600 rounded-xl p-10 my-10 text-center">
        <h3 class="text-red-500 text-2xl font-semibold mb-5">No Exercises Generated</h3>
        <p class="text-gray-300 text-lg mb-8">Try adjusting your filters or selecting more options.</p>
        <a href="{% url 'workout_generator_page' %}" class="inline-block py-4 px-8 text-base font-bold bg-gradient-red text-white rounded-lg cursor-pointer transition-all duration-400 uppercase shadow-red hover:scale-105 hover:bg-gradient-blue hover:shadow-blue">
          Back to Generator
        </a>
      </div>
    {% endif %}

    {% if category and exercises or workout %}
      <div class="flex justify-center gap-4 flex-wrap my-12">
        <a href="{% url 'workout_generator_page' %}" class="py-4 px-8 text-base font-bold bg-gradient-red text-white rounded-lg cursor-pointer transition-all duration-400 uppercase shadow-red hover:scale-105 hover:bg-gradient-blue hover:shadow-blue no-underline">
          Generate New Workout
        </a>
        <a href="#" onclick="window.print(); return false;" class="py-4 px-8 text-base font-bold bg-gradient-red text-white rounded-lg cursor-pointer transition-all duration-400 uppercase shadow-red hover:scale-105 hover:bg-gradient-blue hover:shadow-blue no-underline">
          Print Workout
        </a>
        
        <!-- Save workout modal button -->
        <button
          data-modal-target="default-modal"
          data-modal-toggle="default-modal"
          class="py-4 px-8 text-base font-bold bg-gradient-red text-white rounded-lg cursor-pointer transition-all duration-400 uppercase shadow-red hover:scale-105 hover:bg-gradient-blue hover:shadow-blue"
          type="button">
          Save Workout
        </button>
          
        <!-- Main modal -->
        <div id="default-modal" tabindex="-1" aria-hidden="true" class="hidden overflow-y-auto overflow-x-hidden fixed top-0 right-0 left-0 z-50 justify-center items-center w-full md:inset-0 h-[calc(100%-1rem)] max-h-full">
          <div class="relative p-4 w-full max-w-2xl max-h-full">
            <!-- Modal content -->
            <div class="relative bg-white rounded-lg shadow dark:bg-gray-700">
              <!-- Modal header -->
              <div class="flex items-center justify-between p-4 md:p-5 border-b rounded-t dark:border-gray-600 border-gray-200">
                <h3 class="text-xl font-semibold text-gray-900 dark:text-white">
                  Save Workout to Profile
                </h3>
                <button type="button" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm w-8 h-8 ms-auto inline-flex justify-center items-center dark:hover:bg-gray-600 dark:hover:text-white" data-modal-hide="default-modal">
                  <svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14">
                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"/>
                  </svg>
                  <span class="sr-only">Close modal</span>
                </button>
              </div>

              <!-- Modal body -->
              <div class="p-4 md:p-5 space-y-4">
                <form action="" class="max-w-sm mx-auto py-2" id="saveWorkoutForm">
                  {% csrf_token %}
                  <label for="workoutTitle" class="block mb-2 text-base font-medium text-gray-900 dark:text-white">
                    Title
                  </label>
                  <input
                    type="text"
                    id="workoutTitle"
                    name="title"
                    placeholder="Workout Title"
                    class="w-full p-2 mb-4 rounded-md text-sm text-gray-900 bg-gray-50 border border-gray-300 focus:ring-red-500 focus:border-red-500 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-red-500 dark:focus:border-red-500"
                    required
                  >
                  
                  <label for="workoutNotes" class="block mb-2 text-base font-medium text-gray-900 dark:text-white">
                    Workout Notes
                  </label>
                  <textarea
                    id="workoutNotes"
                    name="notes"
                    rows="4"
                    placeholder="Write your notes here..."
                    class="p-2 w-full text-sm text-gray-900 bg-gray-50 rounded-lg border border-gray-300 focus:ring-red-500 focus:border-red-500 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-red-500 dark:focus:border-red-500 resize-none"
                  ></textarea>
                </form>
              </div>

              <!-- Modal footer -->
              <div class="flex items-center p-4 md:p-5 border-t border-gray-200 rounded-b dark:border-gray-600">
                <button
                  id="saveWorkoutBtn"
                  data-modal-hide="default-modal"
                  type="button"
                  class="py-2 px-5 bg-gradient-red text-white rounded-lg font-semibold shadow-lg hover:scale-105 hover:bg-gradient-blue transition-transform duration-300">
                  Save & Close
                </button>
                <span id="saveStatus" class="ml-4 text-sm text-gray-600 dark:text-gray-400"></span>
              </div>
            </div>
          </div>
        </div>
      </div>
    {% endif %}

  </div>

  <footer class="text-center py-10 mt-16">
    <p class="text-white text-base font-bold">MocFit+ © 2025 | Built for Students by Students</p>
  </footer>

  <script>
  document.getElementById('saveWorkoutBtn')?.addEventListener('click', function() {
    const form = document.getElementById('saveWorkoutForm');
    const title = form.querySelector('#workoutTitle').value;
    const notes = form.querySelector('#workoutNotes').value;
    const status = document.getElementById('saveStatus');
    const csrfToken = form.querySelector('[name=csrfmiddlewaretoken]').value;
    
    if (!title) {
      status.textContent = 'Please enter a title';
      status.classList.add('text-red-600');
      return;
    }
    
    status.textContent = 'Saving...';
    status.classList.remove('text-red-600', 'text-green-600');
    
    // Send data to backend
    fetch('{% url "save_workout" %}', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
        'X-CSRFToken': csrfToken
      },
      body: new URLSearchParams({
        'title': title,
        'notes': notes
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        status.textContent = 'Workout saved! Redirecting...';
        status.classList.add('text-green-600');
        
        // Redirect to dashboard after 1 second
        setTimeout(() => {
          window.location.href = data.redirect_url;
        }, 1000);
      } else {
        status.textContent = data.error || 'Error saving workout';
        status.classList.add('text-red-600');
      }
    })
    .catch(error => {
      status.textContent = 'Error: ' + error.message;
      status.classList.add('text-red-600');
    });
  });
</script>
</body>
</html>